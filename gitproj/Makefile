.PHONY: help setup-auth setup-db setup-user setup-project setup-submission setup-all migrate-all docker-up docker-down logs clean docker-logs docker-rebuild docker-clean

# ÐŸÑƒÑ‚ÑŒ Ðº PostgreSQL Ð¸Ð· Postgres.app
PG_PATH=/Applications/Postgres.app/Contents/Versions/17/bin

help:
	@echo "Student Project Hub - ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ"
	@echo ""
	@echo "ðŸ³ Docker ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
	@echo "docker-up         - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð’Ð¡Ð• ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ñ‡ÐµÑ€ÐµÐ· Docker"
	@echo "docker-down       - ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹"
	@echo "docker-logs       - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ Docker"
	@echo "docker-rebuild    - ÐŸÐµÑ€ÐµÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹"
	@echo ""
	@echo "ðŸ—„ï¸ Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
	@echo "pg-check          - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ PostgreSQL"
	@echo "pg-start          - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ PostgreSQL"
	@echo "setup-db          - Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… PostgreSQL"
	@echo ""
	@echo "setup-auth        - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Auth Service"
	@echo "migrate-auth      - ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Auth Service"
	@echo "run-auth          - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Auth Service"
	@echo ""
	@echo "setup-user        - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ User Service"
	@echo "migrate-user      - ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ User Service"
	@echo "run-user          - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ User Service"
	@echo ""
	@echo "setup-project     - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Project Service"
	@echo "migrate-project   - ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Project Service"
	@echo "run-project       - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Project Service"
	@echo ""
	@echo "setup-submission  - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Submission Service"
	@echo "migrate-submission - ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Submission Service"
	@echo "run-submission    - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Submission Service"
	@echo ""
	@echo "setup-all         - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾"
	@echo "migrate-all       - ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸"
	@echo "createsuperuser   - Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ"
	@echo "docker-up         - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹"
	@echo "docker-down       - ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹"
	@echo "logs              - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ Docker"

pg-check:
	@echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° PostgreSQL..."
	@if $(PG_PATH)/psql -l >/dev/null 2>&1; then \
		echo "âœ… PostgreSQL Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"; \
		$(PG_PATH)/psql -l | head -5; \
	else \
		echo "âŒ PostgreSQL Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"; \
		echo ""; \
		echo "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Postgres.app:"; \
		echo "1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¸ÐºÐ¾Ð½ÐºÑƒ ÑÐ»Ð¾Ð½Ð° Ð² Applications"; \
		echo "2. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Postgres.app"; \
		echo "3. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Initialize' Ð¸Ð»Ð¸ 'Start'"; \
		echo ""; \
		echo "Ð˜Ð»Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¸Ð· Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ð°:"; \
		echo "open -a Postgres"; \
		exit 1; \
	fi

pg-start:
	@echo "ðŸ˜ Ð—Ð°Ð¿ÑƒÑÐº PostgreSQL..."
	@open -a Postgres 2>/dev/null || echo "Postgres.app Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Applications"
	@echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° (3 ÑÐµÐº)..."
	@sleep 3
	@make pg-check

setup-db: pg-check
	@echo "ðŸ—„ï¸  Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°Ð· Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
	@$(PG_PATH)/createdb auth_db 2>/dev/null || echo "âœ“ Ð‘Ð°Ð·Ð° auth_db ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
	@$(PG_PATH)/createdb user_db 2>/dev/null || echo "âœ“ Ð‘Ð°Ð·Ð° user_db ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
	@$(PG_PATH)/createdb project_db 2>/dev/null || echo "âœ“ Ð‘Ð°Ð·Ð° project_db ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
	@$(PG_PATH)/createdb submission_db 2>/dev/null || echo "âœ“ Ð‘Ð°Ð·Ð° submission_db ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
	@echo "âœ… Ð‘Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹"

setup-auth:
	@chmod +x setup_auth_service.sh
	@./setup_auth_service.sh

migrate-auth: pg-check setup-db
	@echo "ðŸ”„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹..."
	@cd backend/auth_service && \
	source venv/bin/activate && \
	python manage.py makemigrations authentication && \
	python manage.py makemigrations && \
	python manage.py migrate
	@echo "âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹"

run-auth: pg-check
	@cd backend/auth_service && \
	source venv/bin/activate && \
	python manage.py runserver 8001

setup-user:
	@chmod +x setup_user_service.sh
	@./setup_user_service.sh

migrate-user: pg-check setup-db
	@echo "ðŸ”„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ User Service..."
	@cd backend/user_service && \
	source venv/bin/activate && \
	python manage.py makemigrations profiles && \
	python manage.py makemigrations && \
	python manage.py migrate
	@echo "âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹"

run-user: pg-check
	@cd backend/user_service && \
	source venv/bin/activate && \
	python manage.py runserver 8002

setup-project:
	@chmod +x setup_project_service.sh
	@./setup_project_service.sh

migrate-project: pg-check setup-db
	@echo "ðŸ”„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Project Service..."
	@cd backend/project_service && \
	source venv/bin/activate && \
	python manage.py makemigrations projects && \
	python manage.py makemigrations && \
	python manage.py migrate
	@echo "âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹"

run-project: pg-check
	@cd backend/project_service && \
	source venv/bin/activate && \
	python manage.py runserver 8003

setup-submission:
	@chmod +x setup_submission_service.sh
	@./setup_submission_service.sh

migrate-submission: pg-check setup-db
	@echo "ðŸ”„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Submission Service..."
	@cd backend/submission_service && \
	source venv/bin/activate && \
	python manage.py makemigrations submissions && \
	python manage.py makemigrations && \
	python manage.py migrate
	@echo "âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹"

run-submission: pg-check
	@cd backend/submission_service && \
	source venv/bin/activate && \
	python manage.py runserver 8004

setup-all: setup-auth setup-user setup-project setup-submission
	@echo "âœ… Ð’ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹!"

migrate-all: migrate-auth migrate-user migrate-project migrate-submission
	@echo "âœ… Ð’ÑÐµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹!"

createsuperuser:
	@cd backend/auth_service && \
	source venv/bin/activate && \
	python manage.py createsuperuser

docker-up:
	@echo "ðŸ³ Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ñ‡ÐµÑ€ÐµÐ· Docker..."
	@docker-compose up --build -d
	@echo ""
	@echo "âœ… Ð’ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹!"
	@echo ""
	@echo "ðŸŒ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹:"
	@echo "Frontend:           http://localhost"
	@echo "Auth Service:       http://localhost:8001/swagger/"
	@echo "User Service:       http://localhost:8002/swagger/"
	@echo "Project Service:    http://localhost:8003/swagger/"
	@echo "Submission Service: http://localhost:8004/swagger/"
	@echo ""
	@echo "ðŸ“Š Ð›Ð¾Ð³Ð¸: make docker-logs"
	@echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ: make docker-down"

docker-down:
	@echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
	@docker-compose down
	@echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

docker-logs:
	@docker-compose logs -f

docker-rebuild:
	@echo "ðŸ”„ ÐŸÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
	@docker-compose down
	@docker-compose up --build -d
	@echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿ÐµÑ€ÐµÑÐ¾Ð±Ñ€Ð°Ð½Ñ‹ Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹"

docker-clean:
	@echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Docker..."
	@docker-compose down -v
	@docker system prune -f
	@echo "âœ… Docker Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½"

logs:
	docker-compose logs -f

clean:
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type d -name "venv" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð¾"
